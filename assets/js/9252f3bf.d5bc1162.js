"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[2866],{4143:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"main-documentation/core-concepts/action","title":"Action","description":"Actions are the finest granular level of Orbits.","source":"@site/docs/main-documentation/core-concepts/action.md","sourceDirName":"main-documentation/core-concepts","slug":"/main-documentation/core-concepts/action","permalink":"/orbits/docs/main-documentation/core-concepts/action","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"title":"Action","sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"Core Concepts","permalink":"/orbits/docs/category/core-concepts"},"next":{"title":"Action lifecycle","permalink":"/orbits/docs/main-documentation/core-concepts/action-in-depth"}}');var i=t(4848),o=t(8453);const s={title:"Action",sidebar_position:1},a="Action",c={},l=[{value:"Concepts",id:"concepts",level:2},{value:"Write your first Action",id:"write-your-first-action",level:2},{value:"Persistent storage",id:"persistent-storage",level:2},{value:"Argument",id:"argument",level:3},{value:"Bag",id:"bag",level:3},{value:"Result",id:"result",level:3},{value:"Setting an Action to Error",id:"setting-an-action-to-error",level:2},{value:"Other parameters to be aware of",id:"other-parameters-to-be-aware-of",level:2},{value:"cronActivity",id:"cronactivity",level:3},{value:"Delays",id:"delays",level:3},{value:"In depth",id:"in-depth",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"action",children:"Action"})}),"\n",(0,i.jsx)(n.p,{children:"Actions are the finest granular level of Orbits.\nAn Action represents the potential completion (or failure) of an operation.\nIt stores the state of an operation in a database to be able to retrieve it despite of process failures or network incidents.\nMoreover, it has a lock management that guarantees the consistency of the flow."}),"\n",(0,i.jsx)(n.h2,{id:"concepts",children:"Concepts"}),"\n",(0,i.jsxs)(n.p,{children:["See the ",(0,i.jsx)(n.a,{href:"/orbits/docs/main-documentation/core-concepts/action-in-depth",children:"conceptual documentation"})," for a better understanding on how Actions work."]}),"\n",(0,i.jsx)(n.h2,{id:"write-your-first-action",children:"Write your first Action"}),"\n",(0,i.jsx)(n.p,{children:"Actions allow you to track the state of external processes."}),"\n",(0,i.jsxs)(n.p,{children:["The following example is fictitious \u2014 real-world examples can be found in the ",(0,i.jsx)(n.a,{href:"/orbits/docs/main-documentation/guides/intro",children:"examples folder"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Let\u2019s imagine a library system: we\u2019ll write an Action that launches a delivery order, succeeds if the delivery completes, and fails otherwise."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Step 1: extend the Action class"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { Action } from '@orbits/core';\n\nexport class MyFirstAction extends Action {\n    static permanentName: 'my-first-action';\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"The actionRef is important. When an Action document is stored in the database, the actionRef is also stored. When orbits retrieve the document from the database, it will use this property to know which constructor it should call."}),"\n",(0,i.jsxs)(n.p,{children:["As a consequence, you may not want to change the ",(0,i.jsx)(n.code,{children:"permanentName"}),". Think about it as an id you give to your Action constructor - it is its only purpose.\nIf you don't specify any name, the name of the class will be used as default \u2014 which is more likely to change."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Step 2: choose the format of your argument, bag and result"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { Action } from '@orbits/core';\n\nexport class MyFirstAction extends Action {\n    static permanentName: 'my-first-action';\n\n    IArgument: {\n        bookName: string;\n    };\n\n    IBag: {\n        deliveryPerson: {\n            name: string;\n            phoneNumber: string;\n        };\n    };\n\n    IResult: {\n        deliveryTime: number;\n    };\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Step 3: (optional) write the init method"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { Action } from '@orbits/core';\nimport { LibraryApi, Book } from './my-library';\n\nexport class MyFirstAction extends Action {\n    static permanentName: 'my-first-action';\n\n    IArgument: {\n        bookName: string;\n    };\n\n    IBag: {\n        deliveryPerson: {\n            name: string;\n            phoneNumber: string;\n        };\n    };\n\n    IResult: {\n        deliveryTime: number;\n    };\n\n    book: Book;\n\n    init() {\n        const libraryApi = new LibraryApi();\n        return libraryApi.getBook(this.argument.bookName).then((book) => {\n            this.book = book;\n        });\n    }\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Step 4: write the main method"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"The main method will be called only once during the whole lifecycle of an Action"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { Action } from '@orbits/core';\nimport { LibraryApi, Book } from './my-library';\n\nexport class MyFirstAction extends Action {\n    static permanentName: 'my-first-action';\n\n    IArgument: {\n        bookName: string;\n    };\n\n    IBag: {\n        orderId: number;\n    };\n\n    IResult: {\n        deliveryTime: number;\n    };\n\n    book: Book;\n\n    init() {\n        const libraryApi = new LibraryApi();\n        return libraryApi.getBook(this.argument.bookName).then((book) => {\n            this.book = book;\n        });\n    }\n\n    main() {\n        const libraryApi = new LibraryApi();\n        return libraryApi\n            .createOrder(this.book)\n            .then((orderInfo) => {\n                this.bag = orderInfo;\n                return ActionState.IN_PROGRESS;\n            })\n            .catch((err) => {\n                this.result = err;\n                return ActionState.ERROR;\n            });\n    }\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Step 5: write the watcher method"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The watcher method can be called multiple times while the action is in ",(0,i.jsx)(n.code,{children:"IN_PROGRESS"})," state."]}),"\n",(0,i.jsx)(n.p,{children:"To set the frequency of the call:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { Action } from '@orbits/core';\nimport { LibraryApi, Book } from './my-library';\n\nexport class MyFirstAction extends Action {\n    static permanentName: 'my-first-action';\n\n    IArgument: {\n        bookName: string;\n    };\n\n    IBag: {\n        orderId: number;\n    };\n\n    IResult: {\n        deliveryTime: number;\n    };\n\n    book: Book;\n\n    init() {\n        const libraryApi = new LibraryApi();\n        return libraryApi.getBook(this.argument.bookName).then((book) => {\n            this.book = book;\n        });\n    }\n\n    main() {\n        const libraryApi = new LibraryApi();\n        return libraryApi\n            .createOrder(this.book)\n            .then((orderInfo) => {\n                this.bag = orderInfo;\n                return ActionState.IN_PROGRESS;\n            })\n            .catch((err) => {\n                this.result = err;\n                return ActionState.ERROR;\n            });\n    }\n\n    watcher() {\n        const libraryApi = new LibraryApi();\n        return libraryApi.getOrderState(this.bag.orderId).then((orderState) => {\n            if (orderState === 0) {\n                return ActionState.IN_PROGRESS;\n            } else if (orderState === -1) {\n                return ActionState.ERROR;\n            } else if (orderState === 1) {\n                return ActionState.SUCCESS;\n            }\n        });\n    }\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Step 5:"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["What happens if a ",(0,i.jsx)(n.code,{children:"createOrder"})," worked but, because of a failure, the orderId was not stored in our action database?\nThen, your action would still be in the state ",(0,i.jsx)(n.code,{children:"ActionState.EXECUTING_MAIN"}),".\nAfter a period of time, your action will be in timeout.\nYou can manage this case using the ",(0,i.jsx)(n.code,{children:"onMainTimeout"})," hook."]}),"\n",(0,i.jsx)(n.p,{children:"Depending on the api implementation the library would consume, there are two strategies."}),"\n",(0,i.jsxs)(n.p,{children:["Sometimes api allow you to set an id on the resource you created. In this case, you already have the id and just need to retrieve it.\nSo ",(0,i.jsx)(n.code,{children:"onMainTimeout"})," can just call the already written watcher method.\nExample would be:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// set the id\nconst libraryApi = new LibraryApi();\nlibraryApi.createOrder(this.argument.bookName, this.argument.id || this.bag.id);\n\n// retrieve the order\nexport class MyFirstAction extends Action {\n    //...\n    onMainTimeout(){\n        return this.watcher();//just call the watcher\n    }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"In most cases, you have to write custom logic."}),"\n",(0,i.jsx)(n.p,{children:"For example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"export class MyFirstAction extends Action {\n    //....\n\n    onMainTimeout(){\n        return libraryApi\n                .listOrder({\n                    book: this.argument.bookName,\n                    after: this.dbDoc.createdAt,\n                    before: this.db.stateUpdatedAt,\n                })\n                .then((orders) => {\n                    if (orders.length === 0) {\n                        // no order was created\n                        return ActionState.ERROR;\n                    } else {\n                        // here it depends on the logic of your service,\n                        // because  you cannot be 100% sure the order is the one\n                        // you think it is without more market notions\n                        // In general an order also has a name and phoneNumber,\n                        // which would make sure the order is the right one\n                        this.bag.orderId = orders[0].orderId;\n                        return ActionState.IN_PROGRESS;//as it's IN_PROGRESS, watcher will be called.\n                    }\n                });\n    }\n\n    watcher() {\n        const libraryApi = new LibraryApi();\n        return libraryApi.getOrderState(this.bag.orderId).then((orderState) => {\n            if (orderState === 0) {\n                return ActionState.IN_PROGRESS;\n            } else if (orderState === -1) {\n                return ActionState.ERROR;\n            } else if (orderState === 1) {\n                return ActionState.SUCCESS;\n            }\n        });\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"persistent-storage",children:"Persistent storage"}),"\n",(0,i.jsxs)(n.p,{children:["Each action has a db document assiociated with it.\nThe db document is accessible via the ",(0,i.jsx)(n.code,{children:"dbDoc"})," property. Most properties are internal settings for the framework."]}),"\n",(0,i.jsx)(n.p,{children:"You can modify these properties (if you know what you are doing)."}),"\n",(0,i.jsx)(n.p,{children:"You can also store in these three stores:"}),"\n",(0,i.jsx)(n.h3,{id:"argument",children:"Argument"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"argument"})," property should be set via the ",(0,i.jsx)(n.code,{children:"setArgument()"})," method and must not be changed after the action leaves the ",(0,i.jsx)(n.code,{children:"ActionState.SLEEPING"}),"state.\nThe interface of the ",(0,i.jsx)(n.code,{children:"argument"})," is set via the ",(0,i.jsx)(n.code,{children:"IArgument"})," property of the class."]}),"\n",(0,i.jsxs)(n.p,{children:["If you want to set a default argument, you should override the ",(0,i.jsx)(n.code,{children:"setArgument()"})," property."]}),"\n",(0,i.jsxs)(n.p,{children:["If you want to modify an argument, you should instead see the ",(0,i.jsx)(n.a,{href:"/orbits/docs/main-documentation/core-concepts/action#bag",children:"bag"})," property"]}),"\n",(0,i.jsx)(n.h3,{id:"bag",children:"Bag"}),"\n",(0,i.jsx)(n.p,{children:"Bag is an object stored in database where you can set everything you need during the process (ids, caches...)."}),"\n",(0,i.jsxs)(n.p,{children:["The interface of the ",(0,i.jsx)(n.code,{children:"bag"})," is set via the ",(0,i.jsx)(n.code,{children:"IBag"})," property of the class."]}),"\n",(0,i.jsxs)(n.p,{children:["You can see an example of how to use it in the ",(0,i.jsx)(n.a,{href:"/orbits/docs/main-documentation/core-concepts/action#write-your-first-action",children:"write your first action"})," section."]}),"\n",(0,i.jsx)(n.h3,{id:"result",children:"Result"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"result"})," property is an object stored in database where you set the result of your action."]}),"\n",(0,i.jsxs)(n.p,{children:["The interface of the ",(0,i.jsx)(n.code,{children:"result"})," is set via the ",(0,i.jsx)(n.code,{children:"IResult"})," property of the class."]}),"\n",(0,i.jsx)(n.p,{children:"If your Action belongs to a Workflow, the result object will then be available in the Workflow."}),"\n",(0,i.jsx)(n.h2,{id:"setting-an-action-to-error",children:"Setting an Action to Error"}),"\n",(0,i.jsxs)(n.p,{children:["You can explicitly return ",(0,i.jsx)(n.code,{children:"ActionState.ERROR"}),", and optionally set an error object:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export class MyAction extends Action{\n    watcher() {\n        const libraryApi = new LibraryApi();\n        return libraryApi.getOrderState(this.bag.orderId).then((orderState) => {\n            if (orderState === 0) {\n                return ActionState.IN_PROGRESS;\n            } else if (orderState === -1) {\n                this.setResult(orderState)\n                return ActionState.ERROR;\n            } else if (orderState === 1) {\n                return ActionState.SUCCESS;\n            }\n        });\n    }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"However, there are cases where an error can be implicitly set:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["if an error is thrown in the ",(0,i.jsx)(n.code,{children:"main"})," or in the ",(0,i.jsx)(n.code,{children:"init"})," function"]}),"\n",(0,i.jsxs)(n.li,{children:["if one of the delays expired (see ",(0,i.jsx)(n.a,{href:"#delays",children:"delays"}),")"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'export class MyAction extends Action{\n    main(){\n        throw new Error("this is a test error");//the action will be in ActionState.ERROR and the result of the action will be the thrown error.\n    }\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"other-parameters-to-be-aware-of",children:"Other parameters to be aware of"}),"\n",(0,i.jsx)(n.h3,{id:"cronactivity",children:"cronActivity"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"resume"})," method will be regularly called."]}),"\n",(0,i.jsxs)(n.p,{children:["The Orbits cron will call it when the current date is superior to ",(0,i.jsx)(n.code,{children:"cronActivity.nextActivity"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"You can dynamically modify this property."}),"\n",(0,i.jsxs)(n.p,{children:["By default, each time ",(0,i.jsx)(n.code,{children:"resume()"})," will be called, this date will be updated to the current time plus the ",(0,i.jsx)(n.code,{children:"cronActivity.frequency"})," value. You can dynamically modify this property."]}),"\n",(0,i.jsxs)(n.p,{children:["By default, the ",(0,i.jsx)(n.code,{children:"cronActivity"})," get its value from the ",(0,i.jsx)(n.code,{children:"defaultCronActivity"})," property in the class."]}),"\n",(0,i.jsx)(n.h3,{id:"delays",children:"Delays"}),"\n",(0,i.jsx)(n.p,{children:"Delays represents the amount of time an action can spend in a certain state."}),"\n",(0,i.jsxs)(n.p,{children:["You can set default delays via the ",(0,i.jsx)(n.code,{children:"defaultDelays"})," property. It expects an object of type:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"{\n    [ActionState.IN_PROGRESS] : 10*60*1000,\n    [ActionState.EXECUTING_MAIN]: 30*1000\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"in-depth",children:"In depth"}),"\n",(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.a,{href:"/orbits/docs/main-documentation/core-concepts/action-in-depth",children:"this"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>a});var r=t(6540);const i={},o=r.createContext(i);function s(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);