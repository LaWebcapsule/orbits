"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[7728],{2105:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"documentation/core-concepts/runtime","title":"Environment variables and runtime","description":"Advanced Feature","source":"@site/docs/documentation/core-concepts/runtime.md","sourceDirName":"documentation/core-concepts","slug":"/documentation/core-concepts/runtime","permalink":"/documentation/core-concepts/runtime","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"title":"Environment variables and runtime","sidebar_position":4},"sidebar":"tutorialSidebar","previous":{"title":"Resource","permalink":"/documentation/core-concepts/resource"},"next":{"title":"Executor","permalink":"/documentation/core-concepts/executor"}}');var o=t(4848),r=t(8453);const s={title:"Environment variables and runtime",sidebar_position:4},c="Configure your runtime",a={},l=[{value:"Bootstrapping a runtime",id:"bootstrapping-a-runtime",level:2},{value:"Bootstrapping processus",id:"bootstrapping-processus",level:2},{value:"Waiting for Bootstrap Completion",id:"waiting-for-bootstrap-completion",level:3},{value:"Recommended Project Structure",id:"recommended-project-structure",level:3},{value:"Main entrypoint (<code>index.ts</code>)",id:"main-entrypoint-indexts",level:4},{value:"Ensuring Action Discoverability",id:"ensuring-action-discoverability",level:3},{value:"Recursive import",id:"recursive-import",level:4},{value:"Customizing environment values",id:"customizing-environment-values",level:3},{value:"Under the hood",id:"under-the-hood",level:2},{value:"ActionRuntime and Actions Catalog",id:"actionruntime-and-actions-catalog",level:3},{value:"Actions Registry",id:"actions-registry",level:4},{value:"How Action Resolution Works",id:"how-action-resolution-works",level:4},{value:"Why Action Discovery Matters",id:"why-action-discovery-matters",level:4}];function d(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"configure-your-runtime",children:"Configure your runtime"})}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Advanced Feature"}),(0,o.jsx)(n.br,{}),"\n","This section describes advanced usage of Orbits runtime. Use it if you're customizing how your runtime initializes or need precise control over bootstrapping."]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"The runtime is responsible for establishing the database connection, configuring logging, and preparing the environment to run your Actions and Workflows. It's the central bootstrap point for any Orbits-based application."}),"\n",(0,o.jsx)("img",{src:"/img/singe_runtime.png",alt:"Workflow Orbits"}),"\n",(0,o.jsx)(n.h2,{id:"bootstrapping-a-runtime",children:"Bootstrapping a runtime"}),"\n",(0,o.jsx)(n.h2,{id:"bootstrapping-processus",children:"Bootstrapping processus"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Generates the ",(0,o.jsx)(n.a,{href:"#actions-registry",children:"Action catalog"})]}),"\n",(0,o.jsx)(n.li,{children:"Connects to the database"}),"\n",(0,o.jsx)(n.li,{children:"Configures logging"}),"\n",(0,o.jsxs)(n.li,{children:["Launches the ",(0,o.jsx)(n.code,{children:"ActionJob"})," cron"]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["You can control many of these behaviors through environment variables. See ",(0,o.jsx)(n.a,{href:"#customizing-environment-values",children:"Customizing Environment Values"})," for more details."]}),"\n",(0,o.jsx)(n.h3,{id:"waiting-for-bootstrap-completion",children:"Waiting for Bootstrap Completion"}),"\n",(0,o.jsxs)(n.p,{children:["After instantiating the runtime, you can expliclty wait for the bootstrapping process to complete before creating Actions or Resources:\nTo wait for the end of the bootstrapping process, you can consume the ",(0,o.jsx)(n.code,{children:"ActionRuntime.waitForActiveRuntime"})," promise. Then, you are ready to save your first Action !"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",metastring:'title="src/index.ts"',children:"ActionRuntime.activeRuntime.waitForActiveRuntime.then(() => {\n    const action = new MyAction();\n    action.save();\n})\n"})}),"\n",(0,o.jsxs)(n.admonition,{type:"info",children:[(0,o.jsx)(n.p,{children:"Actions automatically wait for runtime bootstrapping before being saved.\nThe following pattern is therefore equivalent, though less explicit:"}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",metastring:'title="src/index.ts"',children:"ActionRuntime.activeRuntime.waitForActiveRuntime.then(() => {\n    const action = new MyAction();\n    action.save();\n})\n"})})]}),"\n",(0,o.jsxs)(n.admonition,{type:"warning",children:[(0,o.jsx)(n.p,{children:"Be cautious when creating Actions directly after bootstrap. If multiple processes run this script simultaneously or if the same script is run multiple times, duplicate Actions will be created. This is typically not the desired behavior.Instead, use Resources, which properly manage their lifecycle hooks:"}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"ActionRuntime.waitForActiveRuntime.then(()=>{\n    const resource = new MyResource();\n    resource.save();\n})\n"})}),(0,o.jsx)(n.p,{children:"In general:"}),(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"you will set a new Action via an external api call"}),"\n",(0,o.jsx)(n.li,{children:"you can programmatically set a new Resource after the app has been bootstrapped"}),"\n"]})]}),"\n",(0,o.jsx)(n.h3,{id:"recommended-project-structure",children:"Recommended Project Structure"}),"\n",(0,o.jsx)(n.p,{children:"You can bootstrap the runtime anywhere you want in your codebase.\nHowever, we recomend using this pattern :"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["in the ",(0,o.jsx)(n.code,{children:"orbits"})," folder, only write and export classes"]}),"\n",(0,o.jsxs)(n.li,{children:["create an ",(0,o.jsx)(n.code,{children:"orbi.ts"})," file at the root of your orbit runtime folder"]}),"\n",(0,o.jsxs)(n.li,{children:["import your ",(0,o.jsx)(n.code,{children:"orbi.ts"})," file from your ",(0,o.jsx)(n.code,{children:"index.ts"})]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"my-project/\n\u251c\u2500\u2500 src/\n\u2502   \u251c\u2500\u2500 orbits/\n\u2502   \u2502   \u251c\u2500\u2500 orbi.ts\n\u2502   \u2502   \u251c\u2500\u2500 my-action.ts\n\u2502   \u2502   \u251c\u2500\u2500 my-workflow.ts\n\u2502   \u2514\u2500\u2500 index.ts\n\u2514\u2500\u2500 package.json\n"})}),"\n",(0,o.jsxs)(n.h4,{id:"main-entrypoint-indexts",children:["Main entrypoint (",(0,o.jsx)(n.code,{children:"index.ts"}),")"]}),"\n",(0,o.jsx)(n.p,{children:"Import the bootstrap file in your main entry point and wait for the runtime to be ready:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",metastring:"title='src/index.ts'",children:"import './orbits/orbi.js'\nimport { ActionRuntime } from '@wbce/orbits-core'\n\n// Your runtime context\nasync function main() {\n    await ActionRuntime.waitForActiveRuntime\n    \n    // Your runtime logic here\n}\n\nmain().catch(console.error)\n\n"})}),"\n",(0,o.jsx)(n.h3,{id:"ensuring-action-discoverability",children:"Ensuring Action Discoverability"}),"\n",(0,o.jsx)(n.p,{children:"For complex runtimes (e.g. using executors), ensure your Actions are discoverable by the runtime through proper import chains.\nThe discovery of actions is done through a recursive import algorithm."}),"\n",(0,o.jsx)(n.h4,{id:"recursive-import",children:"Recursive import"}),"\n",(0,o.jsx)(n.p,{children:"Structure your imports so the runtime can discover all Actions through the dependency chain:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",metastring:"title='src/orbits/my-action.ts'",children:"//ensure you export the action\nexport class MyAction extends Action{\n    //....\n}\n"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",metastring:"title='src/orbits/my-workflow.ts'",children:'// Import and use the action\nimport {MyAction} from "./my-action.ts"\n\nexport class MyWorkflow extends Workflow{\n    //....\n}\n'})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",metastring:"title='src/orbits/orbi.ts'",children:"// Import workflow, which imports action, ensuring discoverability\nimport \"./my-workflow.ts\"\n//...\nnew ActionRuntime({\n    db: {\n        mongo: {\n            url: 'mongodb://localhost:27017/example'\n        }\n    }\n})\n"})}),"\n",(0,o.jsxs)(n.admonition,{type:"warning",children:[(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Bad Pattern - Action Not Discoverable"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",metastring:"title='src/orbits/my-workflow.ts'",children:'// \u274c MySecondAction is not exported\nclass MySecondAction extends Action {\n   // Action implementation\n}\n\nexport class MyWorkflow extends Workflow {\n   define() {\n       // ...something\n       await this.do("second-step", new MySecondAction()); // \u274c MySecondAction is not exported, so it won\'t be registered in the runtime catalog\n   }\n}\n'})}),(0,o.jsx)(n.p,{children:"Even if MySecondAction is only consumed by MyWorkflow, you should export it."})]}),"\n",(0,o.jsx)(n.h3,{id:"customizing-environment-values",children:"Customizing environment values"}),"\n",(0,o.jsx)(n.p,{children:"You can configure the runtime through environment variables. These are especially useful for deployment environments or fine-tuning runtime behavior."}),"\n",(0,o.jsx)(n.p,{children:"Here are some commonly used variables:"}),"\n",(0,o.jsxs)(n.table,{children:[(0,o.jsx)(n.thead,{children:(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.th,{children:"Variable"}),(0,o.jsx)(n.th,{children:"Description"}),(0,o.jsx)(n.th,{children:"Default"})]})}),(0,o.jsxs)(n.tbody,{children:[(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:"ORBITS_DB__MONGO__URL"}),(0,o.jsx)(n.td,{children:"the url to connect to mongodb"}),(0,o.jsx)(n.td,{children:(0,o.jsx)(n.code,{children:"mongodb://localhost:27017/orbits"})})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:"ORBITS_WORKERS__QUANTITY"}),(0,o.jsxs)(n.td,{children:["the number of ",(0,o.jsx)(n.code,{children:"ActionJob"})," that will be launched"]}),(0,o.jsx)(n.td,{children:"3"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:"ORBITS_LOGGING__LEVEL"}),(0,o.jsx)(n.td,{children:"the level that will be use by the logger to filter the log"}),(0,o.jsx)(n.td,{children:"'info'"})]})]})]}),"\n",(0,o.jsx)(n.h2,{id:"under-the-hood",children:"Under the hood"}),"\n",(0,o.jsx)(n.h3,{id:"actionruntime-and-actions-catalog",children:"ActionRuntime and Actions Catalog"}),"\n",(0,o.jsxs)(n.p,{children:["ActionRuntime maintains two special properties: ",(0,o.jsx)(n.code,{children:"actionsRegistry"})," and ",(0,o.jsx)(n.code,{children:"invertedActionsRegistry"}),"."]}),"\n",(0,o.jsx)(n.h4,{id:"actions-registry",children:"Actions Registry"}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"actionsRegistry"})," serves as the catalog of all ",(0,o.jsx)(n.code,{children:"Actions"})," available in your runtime. This registry is crucial for the runtime's ability to execute workflows and actions dynamically."]}),"\n",(0,o.jsx)(n.h4,{id:"how-action-resolution-works",children:"How Action Resolution Works"}),"\n",(0,o.jsx)(n.p,{children:"When a worker encounters a workflow in a pending state or an action waiting for execution, it must map database documents back to their corresponding action constructors. Here's the process:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Database Storage"}),": The database stores only a reference to the constructor, not the actual code"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Reference Types"}),": This reference can be either:"]}),"\n"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"The name of the constructor class"}),"\n",(0,o.jsxs)(n.li,{children:["The static ",(0,o.jsx)(n.code,{children:"permanentRef"})," property of the ActionConstructor"]}),"\n"]}),"\n",(0,o.jsxs)(n.ol,{start:"3",children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Constructor Resolution"}),": The worker uses this reference to look up the actual constructor in the ",(0,o.jsx)(n.code,{children:"actionsRegistry"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Execution"}),": Once resolved, the worker can instantiate the action and call its ",(0,o.jsx)(n.code,{children:"main"})," function"]}),"\n"]}),"\n",(0,o.jsx)(n.h4,{id:"why-action-discovery-matters",children:"Why Action Discovery Matters"}),"\n",(0,o.jsx)(n.p,{children:"If ActionRuntime cannot discover your action constructor during bootstrap, the following problems occur:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["The action won't be added to the ",(0,o.jsx)(n.code,{children:"actionsRegistry"})]}),"\n",(0,o.jsx)(n.li,{children:"Workers cannot resolve database references to action constructors"}),"\n",(0,o.jsx)(n.li,{children:"Runtime errors are thrown when attempting to execute the action"}),"\n",(0,o.jsx)(n.li,{children:"Workflows that depend on the action will fail"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"This is why proper action registration through exports and imports is essential for runtime functionality."})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>c});var i=t(6540);const o={},r=i.createContext(o);function s(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);