"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[7069],{6211:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>p,frontMatter:()=>s,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"main-documentation/core-concepts/app","title":"Application","description":"Application manages connection to your database and serves as the central bootstrap point for your Orbits application.","source":"@site/docs/main-documentation/core-concepts/app.md","sourceDirName":"main-documentation/core-concepts","slug":"/main-documentation/core-concepts/app","permalink":"/orbits/docs/main-documentation/core-concepts/app","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"title":"Application","sidebar_position":4},"sidebar":"tutorialSidebar","previous":{"title":"Resource","permalink":"/orbits/docs/main-documentation/core-concepts/resource"},"next":{"title":"Executor","permalink":"/orbits/docs/main-documentation/core-concepts/executor"}}');var i=t(4848),r=t(8453);const s={title:"Application",sidebar_position:4},c="Application documentation",a={},l=[{value:"Waiting for Bootstrap Completion",id:"waiting-for-bootstrap-completion",level:2},{value:"Recommended Project Structure",id:"recommended-project-structure",level:2},{value:"Bootstrap file (<code>orbi.ts</code>)",id:"bootstrap-file-orbits",level:3},{value:"Main entrypoint (<code>index.ts</code>)",id:"main-entrypoint-indexts",level:3},{value:"Ensuring Action Discoverability",id:"ensuring-action-discoverability",level:2},{value:"Method 1: Recursive import",id:"method-1-recursive-import",level:3},{value:"Method 2: Direct Registration",id:"method-2-direct-registration",level:3},{value:"ActionApp and Actions Catalog",id:"actionapp-and-actions-catalog",level:2},{value:"Actions Registry",id:"actions-registry",level:3},{value:"How Action Resolution Works",id:"how-action-resolution-works",level:3},{value:"Why Action Discovery Matters",id:"why-action-discovery-matters",level:3}];function d(e){const n={code:"code",div:"div",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"application-documentation",children:"Application documentation"})}),"\n",(0,i.jsx)(n.p,{children:"Application manages connection to your database and serves as the central bootstrap point for your Orbits application."}),"\n",(0,i.jsx)(n.h1,{id:"bootstrapping-an-application",children:"Bootstrapping an Application"}),"\n",(0,i.jsxs)(n.p,{children:["To initialize your application, create a new ",(0,i.jsx)(n.code,{children:"ActionApp"})," instance with your database configuration:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"new ActionApp({\n    db: {\n        mongo: {\n            url: 'mongodb://localhost:27017/example'\n        }\n    }\n})\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"ActionApp"})," constructor requires a database configuration object. Currently, MongoDB is supported through the ",(0,i.jsx)(n.code,{children:"mongo"})," property, which accepts a connection URL."]}),"\n",(0,i.jsx)(n.h2,{id:"waiting-for-bootstrap-completion",children:"Waiting for Bootstrap Completion"}),"\n",(0,i.jsxs)(n.p,{children:["After instantiating the application, wait for the bootstrapping process to complete before creating Actions or Resources:\nTo wait for the end of the bootstrapping process, you can consume the ",(0,i.jsx)(n.code,{children:"ActionApp.waitForActiveApp"})," promise. Then, you are ready to save your first Action !"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"ActionApp.waitForActiveApp.then(() => {\n    const action = new MyAction();\n    action.save();\n})\n"})}),"\n",(0,i.jsx)(n.div,{}),"\n",(0,i.jsx)(n.p,{children:"Be cautious when creating Actions directly after bootstrap. If multiple processes run this script simultaneously or if the same script is run multiple times, duplicate Actions will be created. This is typically not the desired behavior.Instead, use Resources, which properly manage their lifecycle hooks:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"ActionApp.waitForActiveApp.then(()=>{\n    const resource = new MyResource();\n    resource.save();\n})\n"})}),"\n",(0,i.jsx)(n.p,{children:"In general:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"you will set a new Action via an external api call"}),"\n",(0,i.jsx)(n.li,{children:"you can programmatically set a new Resource after the app has been bootstrapped"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"::"}),"\n",(0,i.jsx)(n.h2,{id:"recommended-project-structure",children:"Recommended Project Structure"}),"\n",(0,i.jsx)(n.p,{children:"You can bootstrap the application anywhere you want in your codebase.\nHowever, we recomend using this pattern :"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["create an ",(0,i.jsx)(n.code,{children:"orbi.ts"})," file at the root of your orbit application folder"]}),"\n",(0,i.jsxs)(n.li,{children:["instanciante the app in ",(0,i.jsx)(n.code,{children:"orbit.ts"})]}),"\n",(0,i.jsxs)(n.li,{children:["import your ",(0,i.jsx)(n.code,{children:"orbi.ts"})," file from your ",(0,i.jsx)(n.code,{children:"index.ts"})]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"my-project/\n\u251c\u2500\u2500 src/\n\u2502   \u251c\u2500\u2500 orbits/\n\u2502   \u2502   \u251c\u2500\u2500 orbi.ts\n\u2502   \u2502   \u251c\u2500\u2500 my-action.ts\n\u2502   \u2502   \u251c\u2500\u2500 my-workflow.ts\n\u2502   \u2514\u2500\u2500 index.ts\n\u2514\u2500\u2500 package.json\n"})}),"\n",(0,i.jsxs)(n.h3,{id:"bootstrap-file-orbits",children:["Bootstrap file (",(0,i.jsx)(n.code,{children:"orbi.ts"}),")"]}),"\n",(0,i.jsxs)(n.p,{children:["Create an ",(0,i.jsx)(n.code,{children:"orbi.ts"})," file in your orbits directory to contain the application initialization:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:"title='src/orbits/orbi.ts'",children:"new ActionApp({\n    db: {\n        mongo: {\n            url: 'mongodb://localhost:27017/example'\n        }\n    }\n})\n"})}),"\n",(0,i.jsxs)(n.h3,{id:"main-entrypoint-indexts",children:["Main entrypoint (",(0,i.jsx)(n.code,{children:"index.ts"}),")"]}),"\n",(0,i.jsx)(n.p,{children:"Import the bootstrap file in your main entry point and wait for the application to be ready:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:"title='src/index.ts'",children:"import './orbits/orbi.js'\nimport { ActionApp } from '@wbce/orbits-core'\n\n// Your application context\nasync function main() {\n    await ActionApp.waitForActiveApp\n    \n    // Your application logic here\n}\n\nmain().catch(console.error)\n\n"})}),"\n",(0,i.jsx)(n.h2,{id:"ensuring-action-discoverability",children:"Ensuring Action Discoverability"}),"\n",(0,i.jsx)(n.p,{children:"For complex applications (e.g. using executors), ensure your Actions are discoverable by the application through proper import chains.\nYou have two choice."}),"\n",(0,i.jsx)(n.h3,{id:"method-1-recursive-import",children:"Method 1: Recursive import"}),"\n",(0,i.jsx)(n.p,{children:"Structure your imports so the application can discover all Actions through the dependency chain:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:"title='src/orbits/my-action.ts'",children:"//ensure you export the action\nexport class MyAction extends Action{\n    //....\n}\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:"title='src/orbits/my-workflow.ts'",children:'// Import and use the action\nimport {MyAction} from "./my-action.ts"\n\nexport class MyWorkflow extends Workflow{\n    //....\n}\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:"title='src/orbits/orbi.ts'",children:"// Import workflow, which imports action, ensuring discoverability\nimport \"./my-workflow.ts\"\n//...\nnew ActionApp({\n    db: {\n        mongo: {\n            url: 'mongodb://localhost:27017/example'\n        }\n    }\n})\n"})}),"\n",(0,i.jsxs)(n.p,{children:[":: warning\n",(0,i.jsx)(n.strong,{children:"Bad Pattern - Action Not Discoverable"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:"title='src/orbits/my-workflow.ts'",children:'// \u274c MySecondAction is not exported\nclass MySecondAction extends Action {\n   // Action implementation\n}\n\nexport class MyWorkflow extends Workflow {\n   define() {\n       // ...something\n       await this.do("second-step", new MySecondAction()); // \u274c MySecondAction is not exported, so it won\'t be registered in the application catalog\n   }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Even if MySecondAction is only consumed by MyWorkflow, you should export it.\n::"}),"\n",(0,i.jsx)(n.h3,{id:"method-2-direct-registration",children:"Method 2: Direct Registration"}),"\n",(0,i.jsx)(n.p,{children:"Alternatively, you can explicitly declare all Actions and Workflows in your bootstrap file using a custom App class:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:"title='src/orbits/orbi.ts'",children:'import { MyAction } from "./my-action.ts"\nimport { MyWorkflow } from "./my-workflow.ts"\n\nexport class MyApp extends ActionApp {\n   declare = [MyAction, MyWorkflow]\n   register = [\n       // You can register other apps here\n       // ActionApp is included by default, shown here for example\n       ActionApp\n   ]\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Trade-off:"}),"\nMust remember to add new Actions/Workflows to the declare array"]}),"\n",(0,i.jsx)(n.h1,{id:"under-the-hood",children:"Under the hood"}),"\n",(0,i.jsx)(n.h2,{id:"actionapp-and-actions-catalog",children:"ActionApp and Actions Catalog"}),"\n",(0,i.jsxs)(n.p,{children:["ActionApp maintains two special properties: ",(0,i.jsx)(n.code,{children:"actionsRegistry"})," and ",(0,i.jsx)(n.code,{children:"invertedActionsRegistry"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"actions-registry",children:"Actions Registry"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"actionsRegistry"})," serves as the catalog of all ",(0,i.jsx)(n.code,{children:"Actions"})," available in your application. This registry is crucial for the application's ability to execute workflows and actions dynamically."]}),"\n",(0,i.jsx)(n.h3,{id:"how-action-resolution-works",children:"How Action Resolution Works"}),"\n",(0,i.jsx)(n.p,{children:"When a worker encounters a workflow in a pending state or an action waiting for execution, it must map database documents back to their corresponding action constructors. Here's the process:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Database Storage"}),": The database stores only a reference to the constructor, not the actual code"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Reference Types"}),": This reference can be either:"]}),"\n"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"The name of the constructor class"}),"\n",(0,i.jsxs)(n.li,{children:["The static ",(0,i.jsx)(n.code,{children:"permanentRef"})," property of the ActionConstructor"]}),"\n"]}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Constructor Resolution"}),": The worker uses this reference to look up the actual constructor in the ",(0,i.jsx)(n.code,{children:"actionsRegistry"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Execution"}),": Once resolved, the worker can instantiate the action and call its ",(0,i.jsx)(n.code,{children:"main"})," function"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"why-action-discovery-matters",children:"Why Action Discovery Matters"}),"\n",(0,i.jsx)(n.p,{children:"If ActionApp cannot discover your action constructor during bootstrap, the following problems occur:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The action won't be added to the ",(0,i.jsx)(n.code,{children:"actionsRegistry"})]}),"\n",(0,i.jsx)(n.li,{children:"Workers cannot resolve database references to action constructors"}),"\n",(0,i.jsx)(n.li,{children:"Runtime errors are thrown when attempting to execute the action"}),"\n",(0,i.jsx)(n.li,{children:"Workflows that depend on the action will fail"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"This is why proper action registration through exports and imports is essential for application functionality."})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>c});var o=t(6540);const i={},r=o.createContext(i);function s(e){const n=o.useContext(r);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),o.createElement(r.Provider,{value:n},e.children)}}}]);