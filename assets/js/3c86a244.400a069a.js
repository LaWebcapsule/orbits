"use strict";(self.webpackChunkorbits_doc=self.webpackChunkorbits_doc||[]).push([[4638],{28453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>i});var s=n(96540);const a={},c=s.createContext(a);function o(e){const t=s.useContext(c);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),s.createElement(c.Provider,{value:t},e.children)}},67771:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>r,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"documentation/helper/integrations/cdk-agent","title":"CDK Agents","description":"CDK Agents let you programmatically manage and deploy your CDK stacks.","source":"@site/docs/documentation/helper/integrations/cdk-agent.md","sourceDirName":"documentation/helper/integrations","slug":"/documentation/helper/integrations/cdk-agent","permalink":"/documentation/helper/integrations/cdk-agent","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"documentation","previous":{"title":"Pilot your IaC","permalink":"/documentation/helper/"},"next":{"title":"CDK8S Agents","permalink":"/documentation/helper/integrations/cdk8s-agent"}}');var a=n(74848),c=n(28453);const o={},i="CDK Agents",r={},l=[{value:"Installation",id:"installation",level:2},{value:"Encapsulate a cdk constructor",id:"encapsulate-a-cdk-constructor",level:2},{value:"Consuming the agent",id:"consuming-the-agent",level:2},{value:"Agent lifecycle",id:"agent-lifecycle",level:2},{value:"Install step",id:"install-step",level:3},{value:"Update step",id:"update-step",level:3},{value:"Cycle step (drift detection)",id:"cycle-step-drift-detection",level:3},{value:"Uninstall step",id:"uninstall-step",level:3},{value:"Agent output",id:"agent-output",level:2},{value:"AWS credentials",id:"aws-credentials",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.header,{children:(0,a.jsx)(t.h1,{id:"cdk-agents",children:"CDK Agents"})}),"\n",(0,a.jsx)(t.p,{children:"CDK Agents let you programmatically manage and deploy your CDK stacks.\nThey provide an enhanced way of working with the CDK, enabling you to:"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:"Easily write cross-account or cross-region resources sharing;"}),"\n",(0,a.jsx)(t.li,{children:"Extend your IaC logic where necessary (e.g. using SDK calls to create AWS account programmatically);"}),"\n",(0,a.jsx)(t.li,{children:"Redeploy stacks in response to specific events."}),"\n"]}),"\n",(0,a.jsx)(t.h2,{id:"installation",children:"Installation"}),"\n",(0,a.jsxs)(t.p,{children:["The ",(0,a.jsx)(t.code,{children:"CdkAgent"})," construct is part of the ",(0,a.jsx)(t.code,{children:"@orbi-ts/fuel"})," package.\nYou'll need to install it first:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"npm install @orbi-ts/fuel\n"})}),"\n",(0,a.jsx)(t.p,{children:"Then import it :"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-ts",children:"import { CdkAgent } from '@orbi-ts/fuel';\n"})}),"\n",(0,a.jsx)(t.h2,{id:"encapsulate-a-cdk-constructor",children:"Encapsulate a cdk constructor"}),"\n",(0,a.jsxs)(t.p,{children:["Assume you have a CDK stack constructor named ",(0,a.jsx)(t.code,{children:"LambdaStack"}),".\nYou wrap it in a CDK agent by extending the ",(0,a.jsx)(t.code,{children:"CdkAgent"})," class."]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-ts",children:"export class LambdaAgent extends CdkAgent {\n    StackConstructor = `LambdaStack`;\n}\n"})}),"\n",(0,a.jsxs)(t.p,{children:["If ",(0,a.jsx)(t.code,{children:"LambdaStack"})," defines ",(0,a.jsx)(t.a,{href:"https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.Stack.html#exportwbrvalueexportedvalue-options",children:"CloudFormation outputs"}),", you should mention their names through an interface."]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-ts",metastring:'title="src/cdk/lambda-stack.ts"',children:"export class LambdaStack extends Stack {\n    constructor() {\n        //...\n        new cdk.CfnOutput(this, 'roleArn', {\n            value: helloLambdaFunction.role?.roleArn!,\n        });\n    }\n}\n"})}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-ts",metastring:'title="src/orbits/lambda-agent.ts"',children:"export class LambdaAgent extends CdkAgent {\n    StackConstructor = `LambdaStack`;\n\n    declare IOutput: {\n        roleArn: string;\n    };\n}\n"})}),"\n",(0,a.jsx)(t.h2,{id:"consuming-the-agent",children:"Consuming the agent"}),"\n",(0,a.jsx)(t.p,{children:"You can consume cdk agent in any workflow/agent."}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-ts",metastring:'title="src/orbits/my-workflow.ts"',children:"export class MyWorkflow extends Workflow {\n    async define() {\n        //...\n        await this.do(\n            'deployLambda',\n            new LambdaAgent().setArgument({\n                stackName: 'lambda',\n                stackProps: {\n                    //other props that will be passed to the stack constructors.\n                    env: {\n                        account: 'aws-account-id',\n                        region: 'aws-account-region',\n                    },\n                },\n            })\n        );\n    }\n}\n"})}),"\n",(0,a.jsx)(t.h2,{id:"agent-lifecycle",children:"Agent lifecycle"}),"\n",(0,a.jsx)(t.h3,{id:"install-step",children:"Install step"}),"\n",(0,a.jsx)(t.p,{children:"The install step checks whether the target AWS environment has been bootstrapped with the CDK.\nIf not, it automatically bootstraps it."}),"\n",(0,a.jsx)(t.h3,{id:"update-step",children:"Update step"}),"\n",(0,a.jsxs)(t.p,{children:["The update step launches the CDK stack, using ",(0,a.jsx)(t.code,{children:"argument.stackProps"})," as input to the StackConstructor."]}),"\n",(0,a.jsxs)(t.admonition,{type:"info",children:[(0,a.jsxs)(t.p,{children:["For advanced scenarios (e.g. when needing secrets or dynamic inputs), you can override the ",(0,a.jsx)(t.code,{children:"init"})," method."]}),(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-ts",metastring:'title="src/orbits/lambda-agent.ts"',children:"secretValue = '';\nasync init() {\n    this.secretValue = await this.getSecret(this.argument.secretArn);\n}\n"})}),(0,a.jsx)(t.p,{children:"This lets you fetch secrets at runtime and ensures they are never stored by Orbits."})]}),"\n",(0,a.jsx)(t.h3,{id:"cycle-step-drift-detection",children:"Cycle step (drift detection)"}),"\n",(0,a.jsx)(t.p,{children:"By default, there is no cycle step defined.\nHowever, the cycle hook can be used to do drift detection.\nIn this case, just define a cycle hook and choose what to do inside."}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-ts",children:"async defineCycle() {\n    const currentState = await this.do('getCurrentState', () => {\n        // some call with aws sdk\n    });\n    if (currentState !== this.argument.stackProps.someParams) {\n        // choose to redeploy\n        await this.do('redeploy', this.clone().setCommand('Update'));\n    }\n}\n"})}),"\n",(0,a.jsxs)(t.p,{children:["By default, the cycle is run every 10 minutes.\nYou can override this parameter with ",(0,a.jsx)(t.code,{children:"defaultAgentSettings"}),"."]}),"\n",(0,a.jsx)(t.h3,{id:"uninstall-step",children:"Uninstall step"}),"\n",(0,a.jsx)(t.p,{children:"The uninstall step removes the CDK stack from the AWS environment."}),"\n",(0,a.jsx)(t.h2,{id:"agent-output",children:"Agent output"}),"\n",(0,a.jsxs)(t.p,{children:["You can retrieve CloudFormation outputs from the deployed stack using ",(0,a.jsx)(t.code,{children:"getAgentOutput()"})," method."]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-ts",children:"// shortcut to get the cloudformation output of the stacks\nconst lambdaOutput = await this.do('getLambdaOutput', () => {\n    return lambdaAgent.getAgentOutput();\n});\n// output is also available after a deployment\nconst lambdaOutput = await this.do('deployLambda', lambdaAgent);\n"})}),"\n",(0,a.jsxs)(t.p,{children:["The type of ",(0,a.jsx)(t.code,{children:"lambdaOutput"})," will be ",(0,a.jsx)(t.code,{children:"LambdaAgent['IOutput']"}),"."]}),"\n",(0,a.jsx)(t.h2,{id:"aws-credentials",children:"AWS credentials"}),"\n",(0,a.jsxs)(t.p,{children:["If you don't specify anything, the default ",(0,a.jsx)(t.a,{href:"https://docs.aws.amazon.com/cdk/v2/guide/configure-access.html",children:"aws credentials"})," of your environment will be used to deploy your stack to cloudformation.\nYou can specify a specific profile to be used using the ",(0,a.jsx)(t.code,{children:"awsProfile"})," argument of the agent."]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-ts",children:"new LambdaAgent().setArgument({\n    awsProfile: 'my-profile',\n});\n"})})]})}function u(e={}){const{wrapper:t}={...(0,c.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}}}]);